### TODO: 

1. 虚拟互联网络的概念
2. IP地址与物理地址之间的关系
3. 传统的分类的IP地址（包括子网掩码）和无分类域间路由选择CIDR
4. 路由选择协议的工作原理


### 网络层提供的两种服务（虚电路服务和数据报服务）

争论：计算机通信中，可靠交付应当由谁来负责？是网络还是端系统？

电话机用的是端系统来负责可靠性，因为电话机无差错处理能力，必须要可靠地将一端的信息传送到另一端

因特网的设计思路：网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务

可靠性由网络中主机的运输层来负责

### 网际协议IP

IP是无连接服务，数据报不存在按序接受的问题
四个协议：

1. 地址解析协议  ARP(Address Resolution Protocal)
2. 逆地址解析协议  RARP(Reverse Address Resolution Protocal)
3. 网际控制报文协议 ICMP(Internet Control Message Protocal)
4. 网际组管理协议 IGMP（Internet Group Management Protocal)

IP使用1.2， 3.4使用IP

虚拟互连网络：将网络互连起来需要一些中间设备，在网络层中的中间设备是路由器，在网络层**以上**使用的中间设备叫网关（Gateway)

也就是逻辑互连网络，互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用IP协议就可以使
这些性能各异的网络在网络层上看起来好像是一个统一的网络。

有关IP最重要的文档是RFC 791

IP地址编址方法经过的三个阶段：1.分类的IP地址 2.子网的划分 3.构成超网

分类的IP地址：

IP地址 ::= {网络号，主机号}

A，B,C类都是单播地址（一对一通信）  0，  10，   110  主机号分别占3，2，1个字节（1个字节等于8位二进制数）

IP地址不仅仅指明一个主机，还指明了主机所连接到的网络

A类：

  0+7位可供使用。

  如果全0的网络号：this, 本网络

  01111111的网络号： 127，保留作为本地软件环回测试（lookback test)本主机的进程之间的通信之用
  
  全0的主机号：表示主机所连接到的单个网络地址
  
  全1的主机号字段表示该网络上所有主机
  
总结分配范围：

A类：1-126   B类：128.1-191.255   C类：192.0.1 - 223.255.255

IP地址是一种分等级的地址结构， IP管理机构在分配IP地址时只分配网络号（第一级）

路由器的每一个接口都有一个不同网络号的IP地址

IP地址与硬件地址

IP地址放在IP数据报的首报，硬件地址放在放在MAC帧的首部

1. 在IP层抽象的互联网上只能看到IP数据报，虽然IP数据报要经过路由器R1和R2两次转发，
但它在首部中的源地址和目的地址始终分别是IP1和IP2

问题：已经知道了一个机器的IP地址，需要找到其物理地址（ARP)；
或者已经知道了其物理地址，需要找到对应的IP地址(RARP,但是现在DHCP已经包括它了，所以不再单独用这个协议)。

ARP:在主机ARP高速缓存中存放一个从IP地址到硬件地址的映射表，这个映射表时常动态更新

广播发送：我的IP地址是209.0.0.5,我的硬件地址是00-00-C0-15-AD-18，我想知道IP地址是209.0.0.6的主机的硬件地址

单播回应：我的IP地址是209.0.0.6，我的硬件地址是08-00-2B-00-EE-0A

然后A收到B的响应分组后，就可以把B的IP地址和硬件地址的映射写入ARP高速缓存中

生存时间很重要，因为如果你写进了高速缓存，但是对方的硬件坏了换了一个，你不过一点时间删除，那么你就找到这个IP后找不到这个硬件了

ARP是解决**同一个局域网**上的IP和硬件地址映射

IP数据报的格式：

首部（固定部分20字节+可变部分）+数据部分

首部固定部分：版本（4位）如IPv4 + 首部长度（占4位，如果是1111那就首部长度是60字节）+区分服务（占8位）+总长度（占16位，单位为1字节）

+标识（占16位，维持一个计数器，每产生一个数据报，计数器就+1）+标志（占3位，最低位：More Fragment,中间位：Dont Fragment)

+片偏移（占13位，单位为8字节）+生存时间Time To Live(占8位，单位是跳数，到0扔掉数据报）+协议（占8位）+首部检验和（检验首部是否变化）

+源地址（占32位）+ 目的地址（占32位）

IP层转发分组的流程

路由表：每一条路由最主要的是以下两个信息：（目的网络地址，下一跳地址）

IP数据报中没有下一跳路由器的IP地址，那么待转发的数据报又怎样能找到下一跳的路由器呢？

查找路由表 -> 计算硬件地址 -> 写入MAC帧的首部 -> 靠这个硬件地址找到下一跳路由器

分组转发算法： 

1. 从数据报的首部提取目的主机的IP地址D,得到目的网络地址N
2. 若N是此路由器直接相连的某个网络地址，则进行直接交付，直接把数据报交付给目的主机（包括把D转换为具体的硬件地址，把数据报封装为MAC帧，再发送此帧）
3. 查路由表，若其中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器，否则转4
4. 查路由表，若其中有到达网络N的路由，则把数据报传送给路由表中所指明的下一跳路由器，否则转5
5. 若路由表中有默认路由，则把数据报传送给路由表中指明的默认路由器，否则报错
 



### 划分子网和构造超网

划分子网

从两级IP地址到三级IP地址：

1. IP地址的空间利用率有时极低
2. 给每一个物理网络分配一个网络号会使得路由表变得太大因而是网络性能变坏
3. 两级IP地址不够灵活

**划分子网**：为了解决以上问题，增加了**子网号字段**，使两级IP地址变成了三级，<网络号、子网号、主机号>

**子网掩码**：有个数据报（145.13.3.10）达到路由器R1，这个路由器如何把它转发到子网（145.13.3.0）

子网掩码中的1对应原IP地址中网络号和子网号，0对应主机号
           
然后对原IP地址和子网掩码做按位与操作

不划分子网时，为什么还要子网掩码？



### 网际控制报文协议ICMP

### 因特网的路由选择协议
